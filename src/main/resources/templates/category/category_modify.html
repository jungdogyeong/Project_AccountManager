<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïπ¥ÌÖåÍ≥†Î¶¨ Ìé∏Ïßë/Ï∂îÍ∞Ä</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #f9f9f9; display: flex; flex-direction: column; height: 100vh; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: #ffffff; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .top-bar button { background: none; border: none; font-size: 18px; cursor: pointer; width: 50px; text-align: left; }
        .top-bar .spacer { width: 50px; }
        .top-bar h1 { margin: 0; font-size: 18px; font-weight: bold; }
        .main-content { padding: 24px 16px; flex-grow: 1; overflow-y: auto; }
        .name-section { text-align: center; margin-bottom: 32px; }
        .name-section .icon-preview { width: 80px; height: 80px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 40px; color: #aaa; }
        .name-section input { border: none; border-bottom: 2px solid #ccc; background: transparent; font-size: 20px; text-align: center; padding: 8px; width: 80%; max-width: 300px; outline: none; }
        .name-section input:focus { border-bottom-color: #007bff; }
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 16px; }
        .icon-option { width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .icon-option.selected { border-color: #007bff; background-color: #dbeafe; }
        .bottom-buttons { display: flex; gap: 10px; padding: 16px; background: #f9f9f9; }
        .bottom-buttons button { flex-grow: 1; padding: 14px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #doneBtn { background-color: #007bff; color: white; }
        #doneBtn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #deleteBtn { background-color: #e0e0e0; color: #d32f2f; }
        #deleteBtn.hidden { display: none; }
    </style>
</head>
<body>
<div class="top-bar">
    <a href="/category/category_main">
        <button id="backBtn">&lt;</button>
    </a>
    <h1 id="pageTitle"></h1>
    <div class="spacer"></div>
</div>
<div class="main-content">
    <div class="name-section">
        <div class="icon-preview" id="iconPreview">?</div>
        <input type="text" id="categoryNameInput" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ">
    </div>
    <div class="icon-grid" id="iconGrid"></div>
</div>
<div class="bottom-buttons">
    <a href="/category/category_main">
        <button id="deleteBtn">ÏÇ≠Ï†ú</button>
    </a>
    <a href="/category/category_main">
        <button id="doneBtn">ÏôÑÎ£å</button>
    </a>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const pageTitle = document.getElementById("pageTitle");
        const categoryNameInput = document.getElementById("categoryNameInput");
        const deleteBtn = document.getElementById("deleteBtn");
        const doneBtn = document.getElementById("doneBtn");
        const iconPreview = document.getElementById("iconPreview");
        const iconGrid = document.getElementById("iconGrid");

        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        const icons = [ 'üçö', 'üöå', 'üõçÔ∏è', 'üé¨', '‚úàÔ∏è', 'üì±', 'üè†', 'üíä', 'üìö', '‚ú®', '‚òï', 'üí∏', 'üéÅ', 'üê∂', 'üöó', 'üëï', 'üíÑ', 'üéâ', 'üí°', 'üíß' ];
        let selectedIcon = null;

        const urlParams = new URLSearchParams(window.location.search);
        const originalName = decodeURIComponent(urlParams.get('name') || '');
        const originalIcon = decodeURIComponent(urlParams.get('icon') || '');

        function checkDoneButtonState() {
            const hasName = categoryNameInput.value.trim() !== '';
            const hasIcon = selectedIcon !== null;
            doneBtn.disabled = !(hasName && hasIcon);
        }

        icons.forEach(icon => {
            const iconEl = document.createElement('div');
            iconEl.classList.add('icon-option');
            iconEl.textContent = icon;
            iconEl.addEventListener('click', () => {
                document.querySelector('.icon-option.selected')?.classList.remove('selected');
                iconEl.classList.add('selected');
                selectedIcon = icon;
                iconPreview.textContent = selectedIcon;
                iconPreview.style.color = 'inherit';
                checkDoneButtonState();
            });
            iconGrid.appendChild(iconEl);
        });

        categoryNameInput.addEventListener('input', checkDoneButtonState);

        if (originalName && originalIcon) { // Ìé∏Ïßë Î™®Îìú
            pageTitle.textContent = "Ïπ¥ÌÖåÍ≥†Î¶¨ Ìé∏Ïßë";
            categoryNameInput.value = originalName;
            selectedIcon = originalIcon;
            iconPreview.textContent = selectedIcon;
            iconPreview.style.color = 'inherit';
            const currentIconEl = Array.from(iconGrid.children).find(el => el.textContent === selectedIcon);
            currentIconEl?.classList.add('selected');
            deleteBtn.classList.remove("hidden");
            doneBtn.disabled = false;
        } else { // Ï∂îÍ∞Ä Î™®Îìú
            pageTitle.textContent = "Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä";
            deleteBtn.classList.add("hidden");
            checkDoneButtonState();
        }

        document.getElementById("backBtn").addEventListener("click", () => location.href = "category_main.html");

        deleteBtn.addEventListener("click", () => {
           if (confirm(`'${originalName}' Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
               const updatedCategories = categories.filter(c => c.name !== originalName);
               localStorage.setItem('categories', JSON.stringify(updatedCategories));
               alert("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
               location.href = "category_main.html";
           }
        });

        doneBtn.addEventListener("click", () => {
            const newName = categoryNameInput.value.trim();
            const isEditing = originalName !== '';

            // ÏÉà Ïù¥Î¶ÑÏù¥ ÏûêÏã†ÏùÑ Ï†úÏô∏Ìïú Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨ÏôÄ Ï§ëÎ≥µÎêòÎäîÏßÄ Í≤ÄÏÇ¨
            const isDuplicate = categories.some(
                c => c.name === newName && c.name !== originalName
            );

            if (isDuplicate) {
                alert("Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏûÖÎãàÎã§.");
                return;
            }

            if (isEditing) { // Ìé∏Ïßë
                const categoryIndex = categories.findIndex(c => c.name === originalName);
                if (categoryIndex > -1) {
                    categories[categoryIndex] = { name: newName, icon: selectedIcon };
                }
            } else { // Ï∂îÍ∞Ä
                categories.push({ name: newName, icon: selectedIcon });
            }

            localStorage.setItem('categories', JSON.stringify(categories));
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
            location.href = "category_main.html";
        });
    });
</script>
</body>
</html>